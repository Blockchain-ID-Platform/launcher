box: google/golang

build:
  steps:
    - script:
      name: go test
      code: go test ./...

    - script:
      name: go build
      code: go build launch.go

deploy:
  steps:
    # Add our deploy key to SSH
    - add-ssh-key:
      keyname: GIT_KEY

    # Add GitHub's SSH fingerprint to SSH known_hosts
    - add-to-known_hosts:
      hostname: github.com
      fingerprint: 16:27:ac:a5:76:28:2d:36:63:1b:56:4d:eb:df:a6:48
      type: rsa

    - script:
        name: update tags
        code: git fetch --tags

    - script:
        name: get highest version from tags
        code: export VERSION=$(bash incrementVersion.sh)

    - script:
        name: add new annotated tag
        code: git tag -a $VERSION -m "Tagging release version $VERSION"

    - script:
        name: push newly added tag
        code: git push origin $VERSION

    - github-create-release:
        token: $GITHUB_TOKEN
        tag: $VERSION

    - github-upload-asset:
        token: $GITHUB_TOKEN
        file: launch
        content_type: application/octet-stream
